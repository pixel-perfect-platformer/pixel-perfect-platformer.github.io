name: Deploy Pixel-Perfect Platformer (Web + Native)
on: 
  push:
    branches: [ main ]

# WEB + ZIP (Always works)
jobs:
  web:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install butler
      run: |
        curl -L -o butler.zip https://broth.itch.zone/butler/linux-amd64/LATEST/archive/default
        unzip butler.zip
        chmod +x butler

    - name: Upload HTML5 (Play in browser)
      run: ./butler push . krisvih32alt/pixel-perfect-platformer:html --userversion ${{ github.sha }}
      env:
        BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}

    - name: Create HTML5 ZIP download
      run: |
        zip -r pixel-perfect-html.zip .
        ./butler push pixel-perfect-html.zip krisvih32alt/pixel-perfect-platformer:html-zip --userversion ${{ github.sha }}
      env:
        BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}

  # WINDOWS NATIVE (Tauri/Electron)
  windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 20
    - name: Install Windows butler
      run: |
        curl.exe -L -o butler.zip https://broth.itch.zone/butler/windows-amd64/LATEST/archive/default
        tar -xf butler.zip
    - name: Build Tauri Windows
      run: |
        npm install
        npm run tauri build -- --target x86_64-pc-windows-msvc
        Compress-Archive -Path src-tauri/target/release/* -DestinationPath pixel-perfect-windows.zip
    - name: Upload Windows
      run: .\butler.exe push pixel-perfect-windows.zip krisvih32alt/pixel-perfect-platformer:windows --userversion ${{ github.sha }}
      env:
        BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}

  # MAC NATIVE  
  mac:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 20
    - name: Install Mac butler
      run: |
        curl -L -o butler.zip https://broth.itch.zone/butler/darwin-aarch64/LATEST/archive/default
        unzip butler.zip
        chmod +x butler
    - name: Build Tauri Mac
      run: |
        npm install
        npm run tauri build -- --target universal-apple-darwin
        zip -r pixel-perfect-mac.zip src-tauri/target/release/
    - name: Upload Mac
      run: ./butler push pixel-perfect-mac.zip krisvih32alt/pixel-perfect-platformer:mac --userversion ${{ github.sha }}
      env:
        BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}

  # LINUX NATIVE
  linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 20
    - uses: dtolnay/rust-toolchain@stable
    - name: Install Linux deps
      run: |
        sudo apt-get update
        sudo apt-get install -y libwebkit2gtk-4.0-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev libssl-dev build-essential
    - name: Install npm deps & build
      run: npm install && npm run tauri build
    - name: Install butler
      run: |
        curl -L -o butler.zip https://broth.itch.zone/butler/linux-amd64/LATEST/archive/default
        unzip butler.zip
        chmod +x butler
    - name: Upload Linux
      run: |
        zip -r pixel-perfect-linux.zip src-tauri/target/release/
        ./butler push pixel-perfect-linux.zip krisvih32alt/pixel-perfect-platformer:linux --userversion ${{ github.sha }}
      env:
        BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}
