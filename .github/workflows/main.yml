name: Deploy Everywhere (Web + Native)
on: 
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    # Native builds (Tauri)
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      
    - name: Install frontend dependencies
      run: npm ci
      
    - name: Install Tauri dependencies (Linux)
      run: |
        sudo apt-get update
        sudo apt-get install -y libwebkit2gtk-4.0-dev build-essential curl wget

    - name: Install butler
      run: |
        curl -L -o butler.zip https://broth.itch.zone/butler/linux-amd64/LATEST/archive/default
        unzip butler.zip
        chmod +x butler

    # WEB BUILDS (existing)
    - name: Upload HTML5 (Play in browser)
      run: ./butler push . krisvi32alt/pixel-perfect-platformer:html --userversion ${{ github.sha }}
      env:
        BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}

    - name: Create ZIP download
      run: |
        zip -r pixel-perfect.zip .
        ./butler push pixel-perfect.zip krisvih32alt/pixel-perfect-platformer:default
      env:
        BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}

    # NATIVE BUILDS (Tauri)
    - name: Build all Tauri targets
      run: npm run tauri build -- --target universal-apple-darwin,x86_64-pc-windows-msvc,x86_64-unknown-linux-gnu
      
    - name: Upload Windows
      run: |
        zip -r pixel-perfect-windows.zip src-tauri/target/release/
        ./butler push pixel-perfect-windows.zip krisvih32alt/pixel-perfect-platformer:windows
      env:
        BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}

    - name: Upload Mac
      run: |
        zip -r pixel-perfect-mac.zip src-tauri/target/release/
        ./butler push pixel-perfect-mac.zip krisvih32alt/pixel-perfect-platformer:mac
      env:
        BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}

    - name: Upload Linux
      run: |
        zip -r pixel-perfect-linux.zip src-tauri/target/release/
        ./butler push pixel-perfect-linux.zip krisvih32alt/pixel-perfect-platformer:linux
      env:
        BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}
